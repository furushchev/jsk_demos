<launch>
  <arg name="input_cloud" default="/head_camera/depth_registered/points"/>
  <arg name="object_name" default="room73b2-kettle"/>

  <arg name="base_frame_id" default="base_link" />
  <arg name="sensor_frame_id" default="/camera_depth_optical_frame" />

  <group ns="outlet_detection">
    <node name="template_server"
          pkg="pcl_ros" type="pcd_to_pointcloud"
          args="$(find jsk_2017_01_pr2_longterm)/data/$(arg object_name).pcd 1">
      <remap from="cloud_pcd" to="~output"/>
    </node>
    <node name="nodelet_manager"
          pkg="jsk_topic_tools" type="standalone_complexed_nodelet"
          output="screen">
      <rosparam subst_value="true">
        nodelets:
        - name: input_relay
          type: jsk_topic_tools/Relay
          remappings:
          - from: ~input
            to: $(arg input_cloud)
        - name: pass_through_z
          type: pcl/PassThrough
          remappings:
          - from: ~input
            to: input_relay/output
        - name: plane_segmentation
          type: jsk_pcl/OrganizedMultiPlaneSegmentation
          remappings:
          - from: ~input
            to: input_relay/output
        - name: plane_extraction
          type: jsk_pcl/MultiPlaneExtraction
          remappings:
          - from: ~input
            to: input_relay/output
          - from: ~indices
            to: plane_segmentation/output_refined
          - from: ~input_polygons
            to: plane_segmentation/output_refined_polygon
          - from: ~input_coefficients
            to: plane_segmentation/output_refined_coefficients
        - name: polygon_transform
          type: jsk_pcl_utils/PolygonArrayTransformer
          remappings:
          - from: ~input_polygons
            to: plane_segmentation/output_refined_polygon
          - from: ~input_coefficients
            to: place_segmentation/output_refined_coefficients
        - name: icp_registration
          type: jsk_pcl/ICPRegistration
          remappings:
          - from: ~input
            to: pass_through_z/output
          - from: ~input_reference
            to: template_server/output
      </rosparam>
    </node>
    <group ns="pass_through_z">
      <rosparam subst_value="true">
        filter_field_name: z
        filter_limit_min: -0.003
        filter_limit_max: 0.5
        keep_organized: true
        input_frame: $(arg base_frame_id)
        output_frame: $(arg base_frame_id)
      </rosparam>
    </group>
    <group ns="plane_segmentation">
      <rosparam>
        estimate_normal: true
        publish_normal: true
      </rosparam>
    </group>
    <group ns="plane_extraction">
      <rosparam subst_value="true">
        keep_organized: true
        use_sensor_frame: true
        sensor_frame: $(arg sensor_frame_id)
        min_height: 0.01
        max_height: 0.5
        use_async: true
      </rosparam>
    </group>
    <group ns="polygon_transform">
      <rosparam subst_value="true">
        frame_id: $(arg base_frame_id)
      </rosparam>
    </group>
    <group ns="icp_registration">
      <rosparam>
      algorithm: ICP
      transform_3dof: true
      </rosparam>
    </group>
  </group>
</launch>
